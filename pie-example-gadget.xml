<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs
    title="Pie Chart Example"
    author="You"
    description="Simple gadget with user stored issueKey">
    <Require feature="setprefs"/>
    <Require feature="dynamic-height"/>
  </ModulePrefs>

  <!-- USER PREF DEFINITION -->
  <UserPref name="issueKey" display_name="Issue Key" datatype="string" />

  <Content type="html">
    <![CDATA[
<style>
  .box { margin-bottom: 8px; }
</style>

<div class="box">
  <label>Issue Key:</label>
  <input id="issueKey" type="text" />
  <button onclick="saveIssue()">Save</button>
</div>

<canvas id="pieCanvas" width="300" height="300"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  var prefs = gadgets.Prefs();

  function loadIssue() {
    var saved = prefs.getString("issueKey");
    if (saved) {
      document.getElementById("issueKey").value = saved;
      refreshPie();
    }
  }

  function saveIssue() {
    var val = document.getElementById("issueKey").value;
    prefs.set("issueKey", val);
    refreshPie();
  }

  function refreshPie() {
    var key = document.getElementById("issueKey").value;
    if (!key) return;

    var data = {
      labels: ["To Do", "In Progress", "Done"],
      counts: [3, 5, 2]
    };

    drawPie(data);
  }

  var chartInstance = null;

  function drawPie(data) {
    var ctx = document.getElementById('pieCanvas').getContext('2d');

    if (chartInstance != null) {
      chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: data.labels,
        datasets: [{
          data: data.counts
        }]
      }
    });
  }

  loadIssue();
</script>
    ]]>
  </Content>

</Module>
