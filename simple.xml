<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs
        title="Issue Status Gadget"
        author="Example"
        description="Show status of issue">
        <Require feature="authrequest"/>
    </ModulePrefs>

    <UserPref name="issueKey" display_name="Issue Key" default=""/>

    <Content type="html" view="default">
        <![CDATA[
        <html>
        <head>
        <script>
            function loadStatus() {
                var prefs = new gadgets.Prefs();
                var issueKey = prefs.getString("issueKey");

                if (!issueKey) {
                    document.getElementById("status").innerHTML = "No issue selected";
                    return;
                }

                var url = AJS.contextPath() + "/rest/api/2/issue/" + issueKey;

                gadgets.io.makeRequest(
                    url,
                    function(response) {
                        if (response.rc != 200) {
                            document.getElementById("status").innerHTML =
                                "Error: " + response.rc;
                            return;
                        }

                        var data = JSON.parse(response.text);
                        var status = data.fields?.status?.name || "Unknown";

                        document.getElementById("status").innerHTML =
                            "<b>Status:</b> " + status;
                    },
                    {
                        AUTHORIZATION: "cookie",
                        METHOD: "GET"
                    }
                );
            }

            gadgets.util.registerOnLoadHandler(loadStatus);
        </script>
        </head>

        <body>
            <div><b>Issue:</b> __MSG_issueKey__</div>
            <div id="status">Loading...</div>
        </body>
        </html>
        ]]>
    </Content>

    <Content type="html" view="config">
        <![CDATA[
        <html>
        <body>
            <form id="cfgForm">
                Issue Key: <input id="issueKey" type="text"/>
                <button type="submit">Save</button>
            </form>

            <script>
                var prefs = new gadgets.Prefs();
                document.getElementById("issueKey").value = prefs.getString("issueKey");

                document.getElementById("cfgForm").onsubmit = function() {
                    prefs.set("issueKey", document.getElementById("issueKey").value);
                    gadgets.window.close();
                    return false;
                };
            </script>
        </body>
        </html>
        ]]>
    </Content>
</Module>
